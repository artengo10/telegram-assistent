const { getDatabase } = require("../database/db");

class UserProfileService {
  constructor() {
    this.db = null;
  }

  async init() {
    this.db = getDatabase();
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  async addToHistory(userId, message, role = "user") {
    await this.db.run(
      "INSERT INTO chat_history (user_id, role, content) VALUES (?, ?, ?)",
      [userId, role, message]
    );
  }

  // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –±–∞–∑—ã
  async getChatHistory(userId, limit = 10) {
    const messages = await this.db.all(
      `
            SELECT role, content 
            FROM chat_history 
            WHERE user_id = ? 
            ORDER BY timestamp DESC 
            LIMIT ?
        `,
      [userId, limit]
    );

    return messages.reverse();
  }

  // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
  async clearHistory(userId) {
    await this.db.run("DELETE FROM chat_history WHERE user_id = ?", [userId]);
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async saveProfile(userId, profile) {
    await this.db.run(
      `
            INSERT OR REPLACE INTO user_profiles (user_id, name, age, interests, profession)
            VALUES (?, ?, ?, ?, ?)
        `,
      [userId, profile.name, profile.age, profile.interests, profile.profession]
    );
  }

  // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async getProfile(userId) {
    return await this.db.get("SELECT * FROM user_profiles WHERE user_id = ?", [
      userId,
    ]);
  }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
const userService = new UserProfileService();

// –ù–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
function getSystemPrompt(userProfile = null) {
  let profileInfo =
    "–ê—Ä—Ç–µ–º, 17 –ª–µ—Ç, –±–∏–∑–Ω–µ—Å (–ø—Ä–æ–¥–∞–∂–∞ —Ä–µ–∫–ª–∞–º—ã), IT, –ø–ª–∞–Ω—ã –ø–æ –≤–µ–Ω–¥–∏–Ω–≥—É.";

  if (userProfile) {
    profileInfo = `${userProfile.name || "–ê—Ä—Ç–µ–º"}, ${
      userProfile.age || "17"
    } –ª–µ—Ç, `;
    if (userProfile.profession)
      profileInfo += `–±–∏–∑–Ω–µ—Å (${userProfile.profession}), `;
    if (userProfile.interests)
      profileInfo += `–∏–Ω—Ç–µ—Ä–µ—Å—ã: ${userProfile.interests}`;
  }

  return {
    role: "system",
    content: `# –†–æ–ª—å
–¢—ã - –¥–µ–ª–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ${profileInfo}. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–æ–¥–∏—Ç—å –≥–ª—É–±–æ–∫–∏–π —Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã–∂–∏–º–∫—É.

# –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
- –î–µ–ª–æ–≤–æ–π —Ç–æ–Ω
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ë–µ–∑ —Å–º–∞–π–ª–∏–∫–æ–≤
- –ë–µ–∑ water —Ç–µ–∫—Å—Ç–∞
- –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞:
1. –ó–∞–ø—Ä–æ—Å –æ —á–µ–ª–æ–≤–µ–∫–µ (—á—É–≤—Å—Ç–≤–∞, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)
2. –ë–∏–∑–Ω–µ—Å-–∑–∞–ø—Ä–æ—Å (–∫–æ–º–ø–∞–Ω–∏–∏, —Ä—ã–Ω–∫–∏, —Ñ–∏–Ω–∞–Ω—Å—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
3. –ó–∞–ø—Ä–æ—Å –æ –ø—Ä–æ–µ–∫—Ç–µ/–¥–µ–ª–µ (–∑–∞–¥–∞—á–∏, —Ü–µ–ª–∏, —Å—Ä–æ–∫–∏, —Ä–µ—Å—É—Ä—Å—ã)
4. –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π/—ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—Å–º—ã—Å–ª, –∂–∏–∑–Ω—å, –º–æ—Ä–∞–ª—å)
5. –§–∞–∫—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å (–¥–∞–Ω–Ω—ã–µ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)

# –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã
–ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞, –ø—Ä–æ–≤–µ–¥–∏ —Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑:

## –î–ª—è –ó–ê–ü–†–û–°–û–í –û –ß–ï–õ–û–í–ï–ö–ï:
- –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞—â–∏—Ç—ã, —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞, —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
- –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Ñ–∞–∫—Ç—ã

## –î–ª—è –ë–ò–ó–ù–ï–°-–ó–ê–ü–†–û–°–û–í:
- –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —Ä—ã–Ω–æ—á–Ω—ã–µ —Ä–∏—Å–∫–∏, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É–≥—Ä–æ–∑—ã
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —Ä—ã–Ω–æ—á–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞
- –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, —Ä—ã–Ω–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## –î–ª—è –ü–†–û–ï–ö–¢–û–í/–î–ï–õ:
- –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —Ä–∏—Å–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —Å—Ä–æ–∫–∏, –±—é–¥–∂–µ—Ç, –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

# –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –±–µ–∑ water —Ç–µ–∫—Å—Ç–∞:

**üîé –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞:** [–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø]

**üìå –ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:**
- –ê—Å–ø–µ–∫—Ç 1: ...
- –ê—Å–ø–µ–∫—Ç 2: ...
- –ê—Å–ø–µ–∫—Ç 3: ...

**üìâ –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –≤—ã–≤–æ–¥:**
[–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∫—Ä–∞—Ç–∫–æ]

**üìà –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π –≤—ã–≤–æ–¥:**
[–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∫—Ä–∞—Ç–∫–æ]

**‚öñÔ∏è –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥:**
[–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∫—Ä–∞—Ç–∫–æ]

**üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
[–∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É]

–í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–µ–ª–∞–π –≤—ã–∂–∏–º–∫—É –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—É—á–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π.`,
  };
}

module.exports = { userService, getSystemPrompt };
